package main

import (
	"cve-manager/api"
	"cve-manager/database"
	"cve-manager/scheduler"

	log "github.com/sirupsen/logrus"

	"github.com/labstack/echo/v4"
	"github.com/labstack/echo/v4/middleware"
	"gorm.io/gorm"
)

func main() {
	setupLogger()
	db := database.InitDatabase()
	initScheduler(db)
	router := setupEcho(db)
	log.Infof("Starting server on :8080")
	if err := router.Start(":8080"); err != nil {
		log.Fatalf("%w", err)
	}
}

func setupEcho(db *gorm.DB) *echo.Echo {
	router := echo.New()
	router.HideBanner = true
	router.HidePort = true
	router.Static("/", "./front/dist/front/browser")
	// router.Pre(middleware.AddTrailingSlash())
	api.SetupAPI(router, db)

	router.Use(middleware.Recover())
	router.Use(middleware.RequestLoggerWithConfig(middleware.RequestLoggerConfig{
		LogURI:    true,
		LogStatus: true,
		LogMethod: true,
		LogValuesFunc: func(c echo.Context, values middleware.RequestLoggerValues) error {
			log.WithFields(log.Fields{
				"URI":    values.URI,
				"Method": values.Method,
				"Code":   values.Status,
			}).Info("HTTP request")

			return nil
		},
	}))
	return router
}

func initScheduler(db *gorm.DB) *scheduler.Scheduler {
	var Cpes []database.Cpe
	cpeScheduler := scheduler.CreateScheduler(5)
	db.Find(&Cpes)
	log.Infof("Found %d CPEs to watch", len(Cpes))
	if db.Error != nil {
		log.Panicf("Error initializing watchers %w", db.Error)
	}

	for _, cpe := range Cpes {
		cpeScheduler.Enque(cpe.Cpe, scheduler.CheckCPE)
	}
	cpeScheduler.Start()

	return cpeScheduler
}
