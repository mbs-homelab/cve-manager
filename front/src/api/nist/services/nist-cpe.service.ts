import { Injectable, inject } from '@angular/core';
import { NIST_BASE_URL } from '../tokens/nist-base-url.token';
import { Observable } from 'rxjs';
import { HttpClient, HttpHeaders, HttpParams } from '@angular/common/http';
import { Page } from '../../../models/page.model';
import { NistCpeSearchParameter, NistCpeSearchResult } from '../models/nist-cpe.model';
import { NIST_API_KEY } from '../tokens/nist-api-key.token';


@Injectable({
    providedIn: 'root'
})
export class NistCpeService {
    private readonly baseUrl: string = inject(NIST_BASE_URL);

    private readonly cpeSubPath: string = '/cpes/2.0';

    private readonly apiKey: string | null = inject(NIST_API_KEY, { optional: true });

    private readonly httpClient: HttpClient = inject(HttpClient);

    searchCpesCollection(type: NistCpeSearchParameter, value: string, page: Page): Observable<NistCpeSearchResult> {

        let headers: HttpHeaders = new HttpHeaders();
        if (this.apiKey) {
            headers = headers.set('apiKey', this.apiKey);
        }

        const httpParams: HttpParams = new HttpParams()
            .set(type, value)
            .set('resultsPerPage', page.pageSize)
            .set('startIndex', page.pageIndex);
        return this.httpClient.get<NistCpeSearchResult>(`${this.baseUrl}${this.cpeSubPath}`, { headers, params: httpParams });
    }
}
