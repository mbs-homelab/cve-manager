import { ChangeDetectionStrategy, Component, ModelSignal, WritableSignal, inject, model, signal } from '@angular/core';
import { SearchComponent } from '../../components/search/search.component';
import { MatButtonToggleModule } from '@angular/material/button-toggle';
import { NistCpe, NistCpeSearchParameter } from '../../../api/nist/models/nist-cpe.model'
import { SearchOption, searchOptions } from './search-options.const';
import { FormsModule } from '@angular/forms';
import { NistCpeService } from '../../../api/nist/services/nist-cpe.service';
import { Page } from '../../../models/page.model';
import { JsonPipe } from '@angular/common';
import { HttpStatusCode } from '@angular/common/http';
import { NistSearchResultTableComponent } from './nist-search-result-table/nist-search-result-table.component';

@Component({
    selector: 'cve-search-page',
    standalone: true,
    templateUrl: './search-page.component.html',
    styleUrl: './search-page.component.scss',
    changeDetection: ChangeDetectionStrategy.OnPush,
    imports: [
        FormsModule,
        JsonPipe,
        MatButtonToggleModule,
        SearchComponent,
        NistSearchResultTableComponent,
    ],
})
export class SearchPageComponent {
    readonly requestPending: WritableSignal<boolean> = signal<boolean>(false);

    readonly currentCpe: WritableSignal<NistCpe[]> = signal<NistCpe[]>([]);

    readonly searchOptions: SearchOption[] = searchOptions;

    readonly currentNistCpeSearchParameter: ModelSignal<NistCpeSearchParameter> = model<NistCpeSearchParameter>('keywordSearch');

    private page: Page = {
        pageIndex: 0,
        pageSize: 10,
    };

    private readonly nistCpeService: NistCpeService = inject(NistCpeService);

    handleSearch(searchValue: string): void {
        console.log('search', searchValue);
        this.requestPending.set(true);
        this.nistCpeService
            .searchCpesCollection(this.currentNistCpeSearchParameter(), searchValue, this.page)
            .subscribe({
                next: result => {
                    this.currentCpe.set(result.products.map(product => product.cpe));
                },
                error: err => {
                    if (err.status === HttpStatusCode.NotFound) {
                        console.log('NotFound', err);

                    } else {
                        console.log('OtherError', err);
                        // show error notification
                    }
                    this.currentCpe.set([]);
                },
                complete: () => {
                    this.requestPending.set(false);
                },
            });
    }
}
