package api

import (
	"cve-manager/database"
	"net/http"
	"strconv"

	"github.com/labstack/echo/v4"
	"github.com/labstack/gommon/log"
)

func addCveRoutes(group *echo.Group) {
	group.GET("/:id", getCves)
}

func getCves(c echo.Context) error {
	var cve []database.Cve
	limit, err := strconv.Atoi(c.Param("limit"))
	if err != nil {
		limit = 10
	}
	var cpe database.Cpe
	result := dbClient.First(&cpe, "id = ?", c.Param("id"))
	if result.Error != nil {
		return c.JSON(http.StatusNotFound, ApiError{Message: "CPE not found"})
	}
	log.Infof(cpe.Cpe)
	result = dbClient.Where(&database.Cve{Cpe: cpe.Cpe}).Limit(limit).Find(&cve)
	if result.Error != nil {
		return result.Error
	}
	return c.JSON(http.StatusOK, cve)
}
